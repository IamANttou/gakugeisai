<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>1to9 slot</title>
  <style>
    body{
      margin:0;
      font-family:sans-serif;
      background:#0f1724;
      color:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      height:100vh;
      overflow:hidden;
    }
    .wrap{
      height:100%;
      width:100%;
      max-width:960px;
      display:flex;
      flex-direction:column;
      justify-content:flex-start;
      align-items:center;
      padding:10px;
      box-sizing:border-box;
      gap:12px;
    }
    h1{margin:5px;font-size:24px}

    /* スロット */
    .slot-area{
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:6px;
      width:90%;
      max-width:600px;
    }
    .cell{
      aspect-ratio:8/5;
      border:2px solid #444;
      border-radius:6px;
      display:flex;
      align-items:center;
      justify-content:center;
      background:#111;
    }
    .cell img{
      width:100%;
      height:100%;
      object-fit:contain;
    }

    /* ステータスバー（緑ライン部） */
    .status-bar{
      display:flex;
      gap:16px;
      justify-content:center;
      flex-wrap:wrap;
      margin:8px 0;
      border-top:2px solid #0a0;
      padding-top:4px;
    }
    .status-bar div{font-size:clamp(12px,2vw,16px)}

    /* 手札エリア（赤枠部） */
    .hand-area{
      display:flex;
      gap:8px;
      justify-content:center;
      flex-wrap:wrap;
      border:2px solid #a00;
      border-radius:8px;
      padding:6px;
      width:90%;
      max-width:720px;
      min-height:120px;
    }
    .card{
      aspect-ratio:5/8;
      width:14vw;
      max-width:90px;
      border:2px solid #444;
      border-radius:8px;
      cursor:pointer;
      overflow:hidden;
      position:relative;
    }
    .card img{
      width:100%;
      height:100%;
      object-fit:cover;
    }
    .cost{
      position:absolute;
      bottom:2px;
      right:4px;
      background:#000a;
      padding:2px 6px;
      border-radius:4px;
      font-size:clamp(10px,1.5vw,12px);
    }

    /* ボタン */
    .panel{display:flex;gap:12px;margin:8px}
    button{
      padding:8px 14px;
      border:none;
      border-radius:6px;
      background:#f59e0b;
      color:#000;
      font-weight:bold;
      cursor:pointer;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>1to9 slot</h1>

    <!-- スロット -->
    <div class="slot-area" id="slot-area"></div>

    <!-- スピンボタン -->
    <div class="panel">
      <button id="spin">SPIN</button>
    </div>

    <!-- ステータス（緑ライン部） -->
    <div class="status-bar">
      <div id="result"></div>
      <div id="coins">所持コイン: 100</div>
      <div id="mana">マナ: 0</div>
      <div id="best">自己ベスト: 0</div>
    </div>

    <!-- 手札エリア（赤枠部） -->
    <h2>手札</h2>
    <div id="hand" class="hand-area"></div>
  </div>

  <script>
    const symbols=[
      "images/slot1.png","images/slot2.png","images/slot3.png",
      "images/slot4.png","images/slot5.png","images/slot6.png",
      "images/slot7.png","images/slot8.png","images/slot9.png"
    ]
    const rows=3, cols=3
    const slotArea=document.getElementById("slot-area")
    const resultEl=document.getElementById("result")
    const coinsEl=document.getElementById("coins")
    const bestEl=document.getElementById("best")
    const handEl=document.getElementById("hand")
    const manaEl=document.getElementById("mana")

    let coins=100
    let best=localStorage.getItem("bestScore")||0
    let mana=0
    bestEl.innerText="自己ベスト: "+best

    let lastSpinResults=null
    let doubleReward=false
    let insuranceActive=false
    let superspin=false

    // --- Deck/Hand/Discard ---
    const cardTypes=[
      {img:"images/card1.png", type:"reroll", cost:2},
      {img:"images/card2.png", type:"double", cost:2},
      {img:"images/card3.png", type:"wild", cost:3},
      {img:"images/card4.png", type:"insurance", cost:2},
      {img:"images/card5.png", type:"superspin", cost:3},
      {img:"images/card6.png", type:"manarecover", cost:1},
      {img:"images/card7.png", type:"coinplus", cost:1}
    ]

    let deck=[]
    cardTypes.forEach(ct=>{
      for(let i=0;i<4;i++) deck.push({...ct})
    })
    shuffle(deck)

    let hand=[]
    let discard=[]

    function shuffle(array){
      for(let i=array.length-1;i>0;i--){
        const j=Math.floor(Math.random()*(i+1))
        ;[array[i],array[j]]=[array[j],array[i]]
      }
    }
    function drawCard(){
      if(deck.length===0){
        deck=discard
        discard=[]
        shuffle(deck)
      }
      if(deck.length>0){
        const card=deck.pop()
        hand.push(card)
        renderHand()
      }
    }
    function renderHand(){
      handEl.innerHTML=""
      hand.forEach((card,i)=>{
        const d=document.createElement("div")
        d.className="card"
        d.innerHTML=`<img src="${card.img}"><div class="cost">${card.cost}</div>`
        d.onclick=()=>useCard(i)
        handEl.appendChild(d)
      })
    }
    function useCard(i){
      const card=hand[i]
      if(mana<card.cost){
        resultEl.innerText="マナ不足!"
        return
      }
      mana-=card.cost
      updateManaUI()
      hand.splice(i,1)
      discard.push(card)
      applyCardEffect(card)
      renderHand()
    }

    function updateManaUI(){
      manaEl.innerText="マナ: "+mana
    }

    // --- Build slot UI ---
    function buildGrid(results){
      slotArea.innerHTML=""
      for(let r=0;r<rows;r++){
        for(let c=0;c<cols;c++){
          const idx=results[r][c]
          const cell=document.createElement("div")
          cell.className="cell"
          cell.innerHTML=`<img src="${symbols[idx]}">`
          slotArea.appendChild(cell)
        }
      }
    }

    function spin(){
      let results=[]
      for(let r=0;r<rows;r++){
        results[r]=[]
        for(let c=0;c<cols;c++){
          results[r][c]=Math.floor(Math.random()*symbols.length)
        }
      }
      return results
    }

    function checkWin(results){
      let lines=[]
      for(let r=0;r<rows;r++){
        if(results[r][0]===results[r][1]&&results[r][1]===results[r][2])
          lines.push([[r,0],[r,1],[r,2]])
      }
      for(let c=0;c<cols;c++){
        if(results[0][c]===results[1][c]&&results[1][c]===results[2][c])
          lines.push([[0,c],[1,c],[2,c]])
      }
      if(results[0][0]===results[1][1]&&results[1][1]===results[2][2])
        lines.push([[0,0],[1,1],[2,2]])
      if(results[0][2]===results[1][1]&&results[1][1]===results[2][0])
        lines.push([[0,2],[1,1],[2,0]])
      return lines
    }

    function updateCoins(amount){
      coins+=amount
      coinsEl.innerText="所持コイン: "+coins
      if(coins>best){
        best=coins
        localStorage.setItem("bestScore",best)
        bestEl.innerText="自己ベスト: "+best
      }
    }

    function applyCardEffect(card){
      if(card.type==="reroll"){
        const col=Math.floor(Math.random()*cols)
        for(let r=0;r<rows;r++){
          lastSpinResults[r][col]=Math.floor(Math.random()*symbols.length)
        }
        buildGrid(lastSpinResults)
        resultEl.innerText="カード効果: リロール!"
      }
      if(card.type==="double"){
        doubleReward=true
        resultEl.innerText="カード効果: 倍率アップ!"
      }
      if(card.type==="wild"){
        const r=Math.floor(Math.random()*rows)
        const c=Math.floor(Math.random()*cols)
        const newVal=Math.floor(Math.random()*symbols.length)
        lastSpinResults[r][c]=newVal
        buildGrid(lastSpinResults)
        resultEl.innerText="カード効果: ワイルド!"
      }
      if(card.type==="insurance"){
        insuranceActive=true
        resultEl.innerText="カード効果: 保険!"
      }
      if(card.type==="superspin"){
        superspin=true
        resultEl.innerText="カード効果: スーパースピン!"
      }
      if(card.type==="manarecover"){
        mana+=3
        updateManaUI()
        resultEl.innerText="カード効果: マナ+3!"
      }
      if(card.type==="coinplus"){
        updateCoins(10)
        resultEl.innerText="カード効果: コイン+10!"
      }
    }

    document.getElementById("spin").addEventListener("click",()=>{
      // ターン開始: マナ+1 & 1ドロー
      mana++
      updateManaUI()
      drawCard()

      // スピン
      lastSpinResults=spin()
      buildGrid(lastSpinResults)
      let lines=checkWin(lastSpinResults)
      let reward=0
      if(lines.length>0){
        reward=lines.length*5
        if(doubleReward) reward*=2
        updateCoins(reward)
        resultEl.innerText="当たり! +" + reward + "コイン"
      }else{
        if(insuranceActive){
          resultEl.innerText="ハズレ (保険で返却)"
        }else{
          updateCoins(-5)
          resultEl.innerText="ハズレ -5コイン"
        }
      }
      // 効果リセット
      doubleReward=false
      insuranceActive=false
      if(superspin){
        superspin=false
        setTimeout(()=>document.getElementById("spin").click(),500)
      }
    })

    // 初期表示
    lastSpinResults=spin()
    buildGrid(lastSpinResults)
    renderHand()
    updateManaUI()
  </script>
</body>
</html>
