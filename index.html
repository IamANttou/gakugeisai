<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>1to9 slot</title>
<style>
body{
  margin:0;
  font-family:sans-serif;
  background:#0f1724;
  color:#fff;
  display:flex;
  align-items:center;
  justify-content:center;
  height:100vh;
  overflow:hidden;
}
.wrap{
  height:100%;
  width:100%;
  max-width:960px;
  display:flex;
  flex-direction:column;
  justify-content:space-between;
  align-items:center;
  padding:10px;
  box-sizing:border-box;
}
h1{margin:5px;font-size:24px}

/* --- スロットエリア --- */
.slot-area{
  display:grid;
  grid-template-columns:repeat(3,128px); /* 横長セル */
  grid-template-rows:repeat(3,80px);
  gap:6px;
}
.slot-area{
  display:grid;
  grid-template-columns:repeat(3,288px); 
  grid-template-rows:repeat(3,180px);   
  gap:15px; /* セル間の隙間を広めに */
}
.cell{
  width:288px;
  height:180px;
}
/* --- ボタンパネル --- */
.panel{display:flex;gap:6px;margin:8px}
button{
  padding:6px 12px;
  border:none;
  border-radius:6px;
  background:#f59e0b;
  color:#000;
  font-weight:bold;
  cursor:pointer;
}

/* --- ステータスバー --- */
.status-bar {
  display: flex;
  justify-content: space-around;
  align-items: center;
  width: 100%;
  margin: 20px 0;
}
.status-bar div {
  margin: 0 10px;
  font-size:32px;
}

/* --- 手札 --- */
.hand-area{
  display:flex;
  gap:8px;
  margin-top:8px;
  justify-content:center;
  flex-wrap:wrap;
}
.card{
  width:100px;
  aspect-ratio:5/8; /* 縦長カード */
  border:2px solid #444;
  border-radius:8px;
  cursor:pointer;
  overflow:hidden;
  position:relative;
}
.card img{
  width:100%;
  height:100%;
  object-fit:cover;
}
.cost{
  position:absolute;
  bottom:2px;
  right:4px;
  background:#000a;
  padding:2px 6px;
  border-radius:4px;
  font-size:12px;
}
</style>
</head>
<body>
<div class="wrap">
<h1>1to9 slot</h1>

<div class="slot-area" id="slot-area"></div>

<div class="panel">
  <button id="spin">SPIN</button>
  <button id="stop-0">STOP 1列目</button>
  <button id="stop-1">STOP 2列目</button>
  <button id="stop-2">STOP 3列目</button>
</div>

<div class="status-bar">
  <div id="result"></div>
  <div id="coins">所持コイン: 100</div>
  <div id="mana">マナ: 0</div>
  <div id="best">自己ベスト: 0</div>
</div>

<h2>手札</h2>
<div id="hand" class="hand-area"></div>
</div>

<script>
const symbols=[
  "images/slot1.png","images/slot2.png","images/slot3.png",
  "images/slot4.png","images/slot5.png","images/slot6.png",
  "images/slot7.png","images/slot8.png","images/slot9.png"
];
const rows=3, cols=3;
const slotArea=document.getElementById("slot-area")
const resultEl=document.getElementById("result")
const coinsEl=document.getElementById("coins")
const bestEl=document.getElementById("best")
const handEl=document.getElementById("hand")
const manaEl=document.getElementById("mana")

let coins=100
let best=localStorage.getItem("bestScore")||0
let mana=0
bestEl.innerText="自己ベスト: "+best

let doubleReward=false, insuranceActive=false, superspin=false, wildActive=false

// --- Deck ---
const cardTypes=[
   {img:"images/card1.png", type:"reroll", cost:2},
  {img:"images/card2.png", type:"double", cost:2},
  {img:"images/card3.png", type:"wild", cost:3},
  {img:"images/card4.png", type:"insurance", cost:2},
  {img:"images/card5.png", type:"superspin", cost:3},
  {img:"images/card6.png", type:"manarecover", cost:1},
  {img:"images/card7.png", type:"coinplus", cost:1}
]

let deck=[], hand=[], discard=[]
cardTypes.forEach(ct=>{for(let i=0;i<4;i++) deck.push({...ct})})
shuffle(deck)

function shuffle(array){for(let i=array.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[array[i],array[j]]=[array[j],array[i]]}}

function drawCard(){
  if(deck.length===0){deck=discard; discard=[]; shuffle(deck);}
  if(deck.length>0){hand.push(deck.pop()); renderHand();}
}
function renderHand(){
  handEl.innerHTML=""
  hand.forEach((card,i)=>{
    const d=document.createElement("div")
    d.className="card"
    d.innerHTML=`<img src="${card.img}"><div class="cost">${card.cost}</div>`
    d.onclick=()=>useCard(i)
    handEl.appendChild(d)
  })
}
function useCard(i){
  const card=hand[i]
  if(mana<card.cost){resultEl.innerText="マナ不足!"; return;}
  mana-=card.cost
  updateManaUI()
  hand.splice(i,1)
  discard.push(card)
  applyCardEffect(card)
  renderHand()
}
function updateManaUI(){manaEl.innerText="マナ: "+mana}

// --- Weighted Random for easier hits ---
const probs=[0.15,0.15,0.15,0.1,0.1,0.1,0.1,0.075,0.075]; 
function weightedRandom(probArray){
  const rnd=Math.random();
  let sum=0;
  for(let i=0;i<probArray.length;i++){
    sum+=probArray[i];
    if(rnd<sum) return i;
  }
  return probArray.length-1;
}

// --- Slot ---
let lastSpinResults=Array(rows).fill(0).map(()=>Array(cols).fill(0))
let spinIntervals=[null,null,null]

function buildGrid(results){
  slotArea.innerHTML=""
  for(let r=0;r<rows;r++){
    for(let c=0;c<cols;c++){
      const idx=results[r][c]
      const cell=document.createElement("div")
      cell.className="cell"
      cell.innerHTML=`<img src="${symbols[idx]}">`
      slotArea.appendChild(cell)
    }
  }
}

slotArea.addEventListener("click", e => {
  if(!wildActive) return;
  if(!e.target.closest(".cell")) return;
  const cell = e.target.closest(".cell");
  const idx = Array.from(slotArea.children).indexOf(cell);
  const r = Math.floor(idx / cols);
  const c = idx % cols;
  lastSpinResults[r][c] = 0; // slot1.png に変更
  buildGrid(lastSpinResults);
  wildActive = false;
  resultEl.innerText = "ワイルド適用完了！";
});

function checkWin(results){
  let lines=[]
  for(let r=0;r<rows;r++){if(results[r][0]===results[r][1]&&results[r][1]===results[r][2]) lines.push([[r,0],[r,1],[r,2]])}
  for(let c=0;c<cols;c++){if(results[0][c]===results[1][c]&&results[1][c]===results[2][c]) lines.push([[0,c],[1,c],[2,c]])}
  if(results[0][0]===results[1][1]&&results[1][1]===results[2][2]) lines.push([[0,0],[1,1],[2,2]])
  if(results[0][2]===results[1][1]&&results[1][1]===results[2][0]) lines.push([[0,2],[1,1],[2,0]])
  return lines
}

function updateCoins(amount){
  coins+=amount
  coinsEl.innerText="所持コイン: "+coins
  if(coins>best){best=coins; localStorage.setItem("bestScore",best); bestEl.innerText="自己ベスト: "+best}
}

function applyCardEffect(card){
  if(card.type==="reroll"){const col=Math.floor(Math.random()*cols); for(let r=0;r<rows;r++){lastSpinResults[r][col]=weightedRandom(probs)}; buildGrid(lastSpinResults); resultEl.innerText="カード効果: リロール!"}
  if(card.type==="double"){doubleReward=true; resultEl.innerText="カード効果: 倍率アップ!"}
  if(card.type==="wild"){wildActive=true; resultEl.innerText="ワイルド使用！セルをクリックして変更!"}
  if(card.type==="insurance"){insuranceActive=true; resultEl.innerText="カード効果: 保険!"}
  if(card.type==="superspin"){superspin=true; resultEl.innerText="カード効果: スーパースピン!"}
  if(card.type==="manarecover"){mana+=3; updateManaUI(); resultEl.innerText="カード効果: マナ+3!"}
  if(card.type==="coinplus"){updateCoins(10); resultEl.innerText="カード効果: コイン+10!"}
}

// --- SPIN / STOP ---
document.getElementById("spin").onclick=()=>{
  mana++; updateManaUI(); drawCard();
  for(let c=0;c<cols;c++){
    if(spinIntervals[c]) clearInterval(spinIntervals[c])
    spinIntervals[c]=setInterval(()=>{
      for(let r=0;r<rows;r++){lastSpinResults[r][c]=weightedRandom(probs)}
      buildGrid(lastSpinResults)
    },100)
  }
}

for(let c=0;c<cols;c++){
  document.getElementById(`stop-${c}`).onclick=()=>{
    if(spinIntervals[c]){clearInterval(spinIntervals[c]); spinIntervals[c]=null}
    if(spinIntervals.every(iv=>iv===null)){
      let lines=checkWin(lastSpinResults)
      let reward=0
      if(lines.length>0){reward=lines.length*5; if(doubleReward) reward*=2; updateCoins(reward); resultEl.innerText="当たり! +"+reward+"コイン"}
      else{if(insuranceActive){resultEl.innerText="ハズレ (保険で返却)"} else{updateCoins(-5); resultEl.innerText="ハズレ -5コイン"}}
      doubleReward=false; insuranceActive=false
      if(superspin){superspin=false; setTimeout(()=>document.getElementById("spin").click(),500)}
    }
  }
}

// 初期表示
buildGrid(lastSpinResults)
renderHand()
updateManaUI()
</script>
</body>
</html>
