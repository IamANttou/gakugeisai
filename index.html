<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>1to9 slot</title>
<style>
  body{
    margin:0;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;
    background:#071428;
    color:#fff;
    display:flex;
    flex-direction:column;
    align-items:center;
    min-height:100vh;
  }
  h1{
    margin:12px 0;
    font-size:26px;
    color:#facc15;
  }
  /* ステータス横並び（見やすく） */
  .status{
    display:flex;
    gap:14px;
    margin:6px 8px;
    font-size:16px;
    font-weight:600;
    align-items:center;
  }
  .status div{color:#e6eef8}

  /* スロット（画面の1/4） */
  .slot-area{
    display:grid;
    grid-template-columns:repeat(3,1fr);
    grid-template-rows:repeat(3,1fr);
    width:25vw;
    height:25vw;
    gap:14px; /* セル間を広めに */
    margin:12px 0;
  }
  .cell{
    background:#0d1620;
    border:2px solid #2b3a50;
    border-radius:8px;
    display:flex;
    align-items:center;
    justify-content:center;
    overflow:hidden;
    transition:box-shadow .12s;
    cursor:default;
  }
  .cell.clickable{ cursor:pointer; box-shadow:0 0 10px rgba(160,230,255,0.06); }
  .cell img{ width:100%; height:100%; object-fit:cover; display:block; }

  /* ボタンパネル（間隔狭め） */
  .panel{
    display:flex;
    gap:8px;
    margin:6px 0;
  }
  button{
    padding:8px 12px;
    border:none;
    border-radius:8px;
    background:#f59e0b;
    color:#000;
    font-weight:700;
    cursor:pointer;
    font-size:14px;
  }

  /* 手札（間隔狭め） */
  .hand{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    justify-content:center;
    margin:6px 0 18px 0;
  }
  .card{
    width:104px;
    aspect-ratio:5/8; /* 縦長カード */
    background:#0b1320;
    border:2px solid #41546a;
    border-radius:8px;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    font-size:12px;
    cursor:pointer;
    overflow:hidden;
  }
  .card img{ width:100%; height:100%; object-fit:cover; }
  .card .meta{
    position:absolute;
    bottom:6px;
    left:6px;
    right:6px;
    text-align:center;
    font-size:11px;
    color:#e6eef8;
    padding:2px 4px;
    background:rgba(0,0,0,0.25);
    border-radius:6px;
  }

  /* small helper */
  .muted{ color:#9fb0c9; font-weight:500; font-size:13px }
</style>
</head>
<body>
  <h1>1to9 slot</h1>

  <div class="status">
    <div id="coins">コイン: 100</div>
    <div id="mana">マナ: 0</div>
    <div id="best">自己ベスト: 0</div>
    <div id="effect" class="muted">効果: なし</div>
  </div>

  <div class="slot-area" id="slot"></div>

  <div class="panel">
    <button id="spin">SPIN</button>
    <button id="stop-0">STOP 1列目</button>
    <button id="stop-1">STOP 2列目</button>
    <button id="stop-2">STOP 3列目</button>
  </div>

  <div class="hand" id="hand"></div>

<script>
/* ----- 設定 ----- */
const symbols = [
  "images/slot1.png","images/slot2.png","images/slot3.png",
  "images/slot4.png","images/slot5.png","images/slot6.png",
  "images/slot7.png","images/slot8.png","images/slot9.png"
];
const rows=3, cols=3;

/* ----- 状態 ----- */
let coins = 100;
let mana = 0;
let best = parseInt(localStorage.getItem('bestScore') || "0",10);
let lastSpinResults = Array.from({length:rows}, ()=> Array(cols).fill(0));
let spinIntervals = [null,null,null];

let doubleReward=false, insuranceActive=false, superspin=false, wildActive=false;

/* ----- DOM ----- */
const slotArea = document.getElementById("slot");
const coinsEl = document.getElementById("coins");
const manaEl = document.getElementById("mana");
const bestEl = document.getElementById("best");
const effectEl = document.getElementById("effect");
const handEl = document.getElementById("hand");

/* ----- カード定義（各4枚） ----- */
const cardTypes = [
  {img:"images/card1.png", name:"リロール", type:"reroll", cost:2},
  {img:"images/card2.png", name:"倍率×2", type:"double", cost:3},
  {img:"images/card3.png", name:"ワイルド", type:"wild", cost:4},
  {img:"images/card4.png", name:"保険", type:"insurance", cost:2},
  {img:"images/card5.png", name:"スーパースピン", type:"superspin", cost:5},
  {img:"images/card6.png", name:"マナ+3", type:"manarecover", cost:0},
  {img:"images/card7.png", name:"コイン+10", type:"coinplus", cost:0}
];

let deck = [];
let handCards = [];
let discard = [];

/* 山札作成 & シャッフル */
cardTypes.forEach(ct=>{
  for(let i=0;i<4;i++) deck.push({...ct});
});
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }
shuffle(deck);

/* ----- 表示系 ----- */
function updateStatus(effectText){
  coinsEl.innerText = "コイン: " + coins;
  manaEl.innerText = "マナ: " + mana;
  bestEl.innerText = "自己ベスト: " + best;
  effectEl.innerText = "効果: " + (effectText || "なし");
}

/* build grid */
function buildGrid(results){
  slotArea.innerHTML = "";
  for(let r=0;r<rows;r++){
    for(let c=0;c<cols;c++){
      const idx = results[r][c];
      const cell = document.createElement("div");
      cell.className = "cell" + (wildActive ? " clickable" : "");
      cell.dataset.r = r; cell.dataset.c = c;
      const img = document.createElement("img");
      img.src = symbols[idx];
      img.alt = "";
      cell.appendChild(img);
      slotArea.appendChild(cell);
    }
  }
}

/* ----- カード（手札）処理 ----- */
function drawCard(){
  if(deck.length===0){
    // 山札が空なら捨て札を戻してシャッフル
    if(discard.length>0){
      deck = discard.splice(0);
      shuffle(deck);
    } else {
      return;
    }
  }
  handCards.push(deck.pop());
  renderHand();
}
function renderHand(){
  handEl.innerHTML = "";
  handCards.forEach((card,i)=>{
    const d = document.createElement("div");
    d.className = "card";
    d.innerHTML = `<img src="${card.img}" alt=""><div class="meta">${card.name}<br>cost:${card.cost}</div>`;
    d.addEventListener("click", ()=> {
      if(mana < card.cost){
        updateStatus("マナ不足");
        return;
      }
      // マナ消費
      mana -= card.cost;
      updateStatus("カード使用: " + card.name);
      // カードを手札から取り出して捨て札へ
      const used = handCards.splice(i,1)[0];
      discard.push(used);
      applyCardEffect(used);
      renderHand();
      updateStatus(); // 更新（効果テキスト先ほどセット）
    });
    handEl.appendChild(d);
  });
}

/* ----- カード効果 ----- */
function applyCardEffect(card){
  if(card.type === "reroll"){
    // ランダムな1列をリロール（weighted）
    const col = Math.floor(Math.random()*cols);
    for(let r=0;r<rows;r++){
      lastSpinResults[r][col] = weightedRandom();
    }
    buildGrid(lastSpinResults);
    effectEl.innerText = "効果: リロール（列" + (col+1) + "）";
  } else if(card.type === "double"){
    doubleReward = true;
    effectEl.innerText = "効果: 倍率×2";
  } else if(card.type === "wild"){
    wildActive = true;
    effectEl.innerText = "効果: ワイルド - セルをクリックして適用";
  } else if(card.type === "insurance"){
    insuranceActive = true;
    effectEl.innerText = "効果: 保険";
  } else if(card.type === "superspin"){
    superspin = true;
    effectEl.innerText = "効果: スーパースピン";
  } else if(card.type === "manarecover"){
    mana += 3;
    effectEl.innerText = "効果: マナ+3";
  } else if(card.type === "coinplus"){
    coins += 10;
    effectEl.innerText = "効果: コイン+10";
    if(coins > best){ best = coins; localStorage.setItem('bestScore', best); }
  }
  updateStatus();
}

/* ----- Weighted random（当たりやすく補正） ----- */
const probs = [0.15,0.15,0.15,0.1,0.1,0.1,0.1,0.075,0.075]; // index 0..8
function weightedRandom(){
  const rnd = Math.random();
  let s = 0;
  for(let i=0;i<probs.length;i++){
    s += probs[i];
    if(rnd < s) return i;
  }
  return probs.length-1;
}

/* ----- スピン処理（列ごと） ----- */
function startSpinAll(){
  // reset effect text
  effectEl.innerText = "効果: なし";
  doubleReward=false; insuranceActive=false; superspin=false; wildActive=false;
  // start intervals for each column
  for(let c=0;c<cols;c++){
    if(spinIntervals[c]) clearInterval(spinIntervals[c]);
    spinIntervals[c] = setInterval(()=>{
      for(let r=0;r<rows;r++){
        lastSpinResults[r][c] = weightedRandom();
      }
      buildGrid(lastSpinResults);
    }, 80);
  }
}
function stopColumn(c){
  if(spinIntervals[c]){
    clearInterval(spinIntervals[c]);
    spinIntervals[c] = null;
  }
  // 全列停止なら判定とターン終了処理
  if(spinIntervals.every(iv => iv === null)){
    finalizeSpin();
    endTurn();
  }
}
function finalizeSpin(){
  // 判定
  const lines = checkWin(lastSpinResults);
  let reward = lines.length * 25; // お約束: 1ライン25コイン
  if(reward > 0){
    if(doubleReward) reward *= 2;
    coins += reward;
    effectEl.innerText = "当たり! +" + reward + "コイン";
    if(coins > best){ best = coins; localStorage.setItem('bestScore', best); }
  } else {
    if(insuranceActive){
      effectEl.innerText = "ハズレ (保険で返却)";
    } else {
      coins -= 5; // 既定のハズレコスト
      effectEl.innerText = "ハズレ -5コイン";
    }
  }
  updateStatus();
  // reset flags except best (keep)
  doubleReward = false;
  insuranceActive = false;
  if(superspin){
    superspin = false;
    // スーパースピンは自動で再スピン（短delay）
    setTimeout(()=> startSpinAll(), 300);
  }
}

/* 勝利判定（横/縦/斜め） */
function checkWin(results){
  const lines = [];
  // 横
  for(let r=0;r<rows;r++){
    if(results[r][0] === results[r][1] && results[r][1] === results[r][2]){
      lines.push({type:'row', index:r});
    }
  }
  // 縦
  for(let c=0;c<cols;c++){
    if(results[0][c] === results[1][c] && results[1][c] === results[2][c]){
      lines.push({type:'col', index:c});
    }
  }
  // 斜め
  if(results[0][0] === results[1][1] && results[1][1] === results[2][2]){
    lines.push({type:'diag', index:0});
  }
  if(results[0][2] === results[1][1] && results[1][1] === results[2][0]){
    lines.push({type:'diag', index:1});
  }
  return lines;
}

/* ターン終了処理：マナ+1 & 1ドロー */
function endTurn(){
  mana += 1;
  drawCard();
  updateStatus();
}

/* ----- イベントバインド ----- */
document.getElementById("spin").addEventListener("click", ()=>{
  startSpinAll();
});
document.getElementById("stop-0").addEventListener("click", ()=> stopColumn(0));
document.getElementById("stop-1").addEventListener("click", ()=> stopColumn(1));
document.getElementById("stop-2").addEventListener("click", ()=> stopColumn(2));

/* ワイルド適用用のセルクリックハンドラ */
slotArea.addEventListener("click", (e)=>{
  if(!wildActive) return;
  const cell = e.target.closest(".cell");
  if(!cell) return;
  const idx = Array.from(slotArea.children).indexOf(cell);
  if(idx < 0) return;
  const r = Math.floor(idx / cols);
  const c = idx % cols;
  // クリックで slot1.png (index 0) に設定する仕様
  lastSpinResults[r][c] = 0;
  buildGrid(lastSpinResults);
  wildActive = false;
  effectEl.innerText = "ワイルド適用完了！";
});

/* ----- 初期表示 ----- */
buildGrid(lastSpinResults);
updateStatus();
drawCard(); drawCard(); // 最初に手札を2枚引く
</script>
</body>
</html>
