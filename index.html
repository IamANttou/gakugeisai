<script>
let coin=100;
let mana=0;
let turn=1;
let hand=[];
let deck=[];
let discard=[];
let spinInterval=null; // ← グローバル変数で管理
let spinning=false;

const symbols=[
  "images/slot1.png","images/slot2.png","images/slot3.png",
  "images/slot4.png","images/slot5.png","images/slot6.png",
  "images/slot7.png","images/slot8.png","images/slot9.png"
];

const cardTypes=[
  {img:"images/card1.png", type:"reroll", cost:2},
  {img:"images/card2.png", type:"double", cost:2},
  {img:"images/card3.png", type:"wild", cost:3},
  {img:"images/card4.png", type:"insurance", cost:2},
  {img:"images/card5.png", type:"superspin", cost:3},
  {img:"images/card6.png", type:"manarecover", cost:1},
  {img:"images/card7.png", type:"coinplus", cost:1}
];

function initDeck(){
  deck=[];
  for(let i=0;i<2;i++){ deck=deck.concat(cardTypes); }
  shuffle(deck);
}
function shuffle(a){
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
}
function drawCard(){
  if(hand.length>=7) return;
  if(deck.length===0){ deck=discard; discard=[]; shuffle(deck); }
  if(deck.length>0){
    const card=deck.pop();
    hand.push(card);
    renderHand();
  }
}
function renderHand(){
  const handDiv=document.getElementById("hand");
  handDiv.innerHTML="";
  hand.forEach(card=>{
    const c=document.createElement("div");
    c.className="card";
    const img=document.createElement("img");
    img.src=card.img;
    c.appendChild(img);
    handDiv.appendChild(c);
  });
}
function drawSlots(){
  for(let i=0;i<9;i++){
    const cell=document.getElementById("cell"+i);
    const img=document.createElement("img");
    img.src=symbols[Math.floor(Math.random()*symbols.length)];
    cell.innerHTML="";
    cell.appendChild(img);
  }
}

// スピン開始
function spin(){
  if(spinning) return; // 二重起動防止
  const bet=parseInt(document.getElementById("betInput").value)||1;
  if(coin<bet){ alert("コイン不足"); return; }
  coin-=bet;
  document.getElementById("coin").textContent=coin;

  let t=0;
  spinning=true;
  spinInterval=setInterval(()=>{
    drawSlots();
    t++;
    if(t>50){ // 自動で止まる保険
      stopSpin();
    }
  },80);
}

// スピン停止（強制）
function stopSpin(){
  if(!spinning) return;
  clearInterval(spinInterval);
  spinInterval=null;
  spinning=false;

  // 最終確定描画
  drawSlots();

  turn++;
  mana++;
  drawCard();
  document.getElementById("turn").textContent=turn;
  document.getElementById("mana").textContent=mana;
}

// リール停止（縦列だけ）
function stopReel(col){
  if(!spinning) return;
  for(let row=0;row<3;row++){
    const idx=row*3+col;
    const cell=document.getElementById("cell"+idx);
    const img=document.createElement("img");
    img.src=symbols[Math.floor(Math.random()*symbols.length)];
    cell.innerHTML="";
    cell.appendChild(img);
  }
}

// 初期化
initDeck();
drawSlots();
drawCard();
document.getElementById("spinBtn").onclick=()=>spin();
</script>
